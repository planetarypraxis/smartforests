{% load menu_tags static %}

<nav class="navbar navbar-expand-lg navbar-light bg-faded-yellow">
    <div class="container-fluid">
        <a class="navbar-brand text-black fw-normal text-decoration-none font-serif d-flex align-items-center" href="/">
            <div class="d-flex align-items-center">
                <img src="{% static "/img/smart-forests-logo.svg" %}" />
            </div>
        </a>
        <button class="navbar-toggler fs-6 border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto bg-off-white">
                <li class="nav-item d-lg-none border-bottom p-3">
                    <a class="text-dark-green text-decoration-none d-flex justify-content-between align-items-center" href="#">
                        <span>Logbooks</span>
                        <img src="{% static "/img/logbooks.svg" %}" />
                    </a>
                </li>
                <li class="nav-item d-lg-none border-bottom p-3">
                  <a class="text-dark-green text-decoration-none d-flex justify-content-between align-items-center" href="#">
                      <span>Stories</span>
                      <img src="{% static "/img/stories.svg" %}" />
                  </a>
                </li>
                <li class="nav-item d-lg-none border-bottom p-3">
                  <a class="text-dark-green text-decoration-none d-flex justify-content-between align-items-center" href="#">
                    <span>Radio</span>
                    <img src="{% static "/img/radio.svg" %}" />
                  </a>
                </li>
                <li class="nav-item d-lg-none border-bottom p-3">
                  <a class="text-dark-green text-decoration-none d-flex justify-content-between align-items-center" href="#">
                    <span>Map</span>
                    <img src="{% static "/img/map.svg" %}" />
                  </a>
                </li>
                <li class="nav-item dropdown d-none d-lg-block">
                    <a class="nav-link dropdown-toggle text-dark-green bg-faded-yellow" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      Overview
                    </a>
                    <ul class="dropdown-menu border-0 mt-0 bg-off-white shadow-sm" aria-labelledby="navbarDropdown">
                      <li>
                        <a class="dropdown-item text-dark-green d-flex justify-content-between align-items-center" href="#">
                            <span>Logbooks</span>
                            <img src="{% static "/img/logbooks.svg" %}" />
                        </a>
                      </li>
                      <li>
                          <a class="dropdown-item text-dark-green d-flex justify-content-between align-items-center" href="#">
                              <span>Stories</span>
                              <img src="{% static "/img/stories.svg" %}" />
                          </a>
                      </li>
                      <li>
                          <a class="dropdown-item text-dark-green d-flex justify-content-between align-items-center" href="#">
                            <span>Radio</span>
                            <img src="{% static "/img/radio.svg" %}" />
                          </a>
                      </li>
                      <li>
                          <a class="dropdown-item text-dark-green d-flex justify-content-between align-items-center" href="#">
                            <span>Map</span>
                            <img src="{% static "/img/map.svg" %}" />
                          </a>
                      </li>
                      <li><a class="dropdown-item text-dark-green" href="#">Contributors</a></li>
                      <li><a class="dropdown-item text-dark-green" href="#">About</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="d-none d-lg-flex">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item dropdown">
                  <a class="nav-link text-dark-green dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    English
                  </a>
                  <ul class="dropdown-menu border-0 mt-0 bg-off-white shadow-sm" aria-labelledby="navbarDropdown">
                    <li><a class="dropdown-item text-dark-green" href="#">Español</a></li>
                    <li><a class="dropdown-item text-dark-green" href="#">Hindī</a></li>
                    <li><a class="dropdown-item text-dark-green" href="#">Português</a></li>
                  </ul>
              </li>
          </ul>
        </div>
        <a class="btn btn-outline d-none d-lg-block" href="#">
          Login
        </a>
        <button class="btn p-0 ms-5 d-none d-lg-block" type="button" data-bs-toggle="modal" data-bs-target="#searchToggle" aria-controls="searchToggle" aria-expanded="false" aria-label="Toggle search">
            Search<i class="ms-3 icon-search"></i>
        </button>
    </div>
</nav>


<form data-autofocus-show="1" class="modal fade" id="searchToggle" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body bg-darkgrey red-shadow">
                <div class="input-group input-group-focus">
                    <div class="input-group-text bg-white d-flex align-items-center justify-content-center p-3">
                        <i class="icon-search icon-lg"></i>
                    </div>

                    <input id="search-box" name="query" tabindex="1" autofocus class="form-control border-start-0 text-naturalcase heading-medium" autocapitalize="off" autocomplete="off" aria-label="Search">
                </div>
            </div>
            <div class="modal-body p-0">
                <turbo-frame id="search-results" target="_top">
                </turbo-frame>
            </div>
        </div>
    </div>
</form>

<script>
    window.addEventListener('turbo:load', () => {
        const search = document.getElementById('search-box')
        const searchResults = document.getElementById('search-results')
        const modal = new bootstrap.Modal(document.getElementById('searchToggle'))

        searchToggle.addEventListener('submit', e => e.preventDefault())

        search.addEventListener('input', _.debounce(() => {
            searchResults.src = '/search/?query=' + encodeURIComponent(search.value)
        }, 300))

        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault()
                modal.show()
            }
        })

        searchToggle.addEventListener('turbo:frame-load', event => {
            let index = 0

            const down = 40
            const up = 38
            const enter = 13

            const moveSelection = (delta) => {
                searchResults.children[index].classList.remove('active')
                searchResults.children[index + delta].classList.add('active')
                index += delta
            }
            
            search.addEventListener('keydown', (event) => {
                if (event.keyCode == down) {
                    if (index < searchResults.children.length - 1) {
                        moveSelection(+1)
                        event.preventDefault()
                    }
                } else if (event.keyCode == up) {
                    if (index > 0) {
                        moveSelection(-1)
                        event.preventDefault()
                    }
                } else if (event.keyCode == enter) {
                    if (searchResults.children[index].href) {
                        modal.hide()
                        Turbo.visit(searchResults.children[index].href)
                    }
                }
            })
        })
    })
</script>